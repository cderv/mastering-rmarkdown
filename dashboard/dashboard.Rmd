---
title: "Dashboard for SO questions in Rmarkdown Cookbook"
output: 
  flexdashboard::flex_dashboard:
    self_contained: false 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(polite)
library(rvest)
library(purrr)
# control what evaluate or not in dev mode
is_dev <- as.logical(Sys.getenv("IS_DEV", FALSE))
message(ifelse(is_dev, "DEV MODE ON", "DEV MODE OFF")) 
```

```{r parsing-so, eval = FALSE}
# Get Top 500 SO questions
## scrape website
# we want to retrieve the 500 top question
so_url <- "https://stackoverflow.com/questions/tagged/r-markdown"
session <- bow(so_url)
top <- 500
result_per_page <- 50
nb_page <- ceiling(top / 50)
# nb_page <- 1
res <- seq_len(nb_page) %>%
  map(~ scrape(session, 
               params = glue::glue("page={page_nb}&sort=votes&pagesize={result_per_page}", 
                                   page_nb = .x), verbose = TRUE
  ))
```

```{r get-so-qa-url, eval = FALSE}
## get question url
so_top_qa <- res %>%
  map(~html_nodes(.x, "h3 >a.question-hyperlink") %>%
        html_attr("href") %>%
        map_chr(~ httr::modify_url(so_url, path = .x))) %>%
  flatten_chr() %>%
  tibble(urls = .) %>%
  mutate(
    top = row_number(),
    id = str_extract(urls, "(?<=/)\\d{8}(?=/)") 
  )
readr::write_csv("TOP500_QA_SO.csv")
```

```{r get-so-in-gh, eval = TRUE}
# REM : NOT RUN IN DEV MODE (if IS_DEV env var is true)
# Find QA already looked at on GH
# Use github graphQL API
if (!is_dev){
  library(ghrecipes)
  owner <- "mikey-harper"
  repo <- "rmarkdown-cookbook"
  ignored_issues <- c(4)
  issues <- get_issue_labels_state(owner, repo)
  get_all_thread <- map_dfr(issues$number, ~ get_issue_thread(owner, repo, .x))
  so_in_gh <- get_all_thread %>%
    select(issue, body) %>%
    # do not select some issue
    filter(issue != 4) %>%
    # get only issues with stackoverflow url
    mutate(has_so_url = str_detect(body, "https://stackoverflow.com")) %>%
    filter(has_so_url) %>%
    mutate(so_url = str_extract_all(body, "\\bhttps://stackoverflow.com/[^\\s)]*")) %>%
    unnest(so_url) %>%
    # deal with comment shared url
    mutate(so_url = map_if(so_url, 
                           ~str_detect(.x, "https://stackoverflow.com/a/.*"), 
                           ~httr::GET(.x)$url) %>% flatten_chr,
           id = str_extract(so_url, "(?<=questions/)\\d{8}(?=/.*)")) %>%
    select(issue, so_url_gh = so_url, id) %>%
    distinct()
}
```
  
```{r rds-for-dev, eval = FALSE}
# saved once for dev purposes
saveRDS(so_in_gh, "so_in_gh.rds")
```

```{r load-dev-table, eval = FALSE}
# only run if IS_DEV env var is TRUE
# Purpose : Prevent github api request in dev mode
if (is_dev) {
  so_in_gh <- readRDS("so_in_gh.rds")
}
```


```{r data-top-500-in-gh}
# summary of already dealt issues
top_QA <- read_csv("TOP500_QA_SO.csv", col_types = "cic")
full_table <- so_in_gh %>%
  full_join(top_QA, by = "id") %>%
  select(top, urls, id, issue) %>%
  arrange(top) %>%
  mutate(
    # build url for SO questions not in the top 500
    urls = if_else(is.na(top), paste0("https://stackoverflow.com/questions/", id), urls),
    # create link
    urls = map_chr(urls, ~htmltools::a(.x, href = .x, target="_blank") %>% as.character),
    # create link toward issue
    issue_link = map_chr(
      issue, 
      ~htmltools::a(.x,
                    href = paste0("https://github.com/mikey-harper/rmarkdown-cookbook/issues/", .x),
                    target="_blank") %>%
        as.character()
    ))
```


Dashboard
===========================

Updated: `r Sys.time()`

Column
----------------------------------------

### SO QA

```{r barplot-done}
full_table %>%
  mutate(not_in_gh = if_else(is.na(issue), "not in GH yet", "Already in GH")) %>%
  ggplot(aes(not_in_gh, fill = not_in_gh)) +
  geom_bar(position = "dodge") +
  geom_text(aes(label = stat(count), y = stat(count)), stat = "count", vjust = -0.5, hjust = 0.5) +
  theme_light() +
  scale_x_discrete(breaks = NULL) +
  labs(
    title = "Nb of SO questions in GH issues",
    x = NULL,
    fill = "Top SO QA"
  )
```

Column
-------------------------------------------

### Achievement for the top 500

```{r achievement-gauge}
rate <- full_table %>% 
  distinct(id, .keep_all = TRUE) %>%
  filter(!is.na(top)) %>%
  count(ok = !is.na(issue)) %>% 
  filter(ok) %>% 
  pull(n)
flexdashboard::gauge(rate, 0, 
                     full_table %>% 
                       filter(!is.na(top)) %>%
                       distinct(id) %>%
                       count() %>%
                       pull(n))
```

### Next Questions

```{r left-questions}
full_table %>%
  filter(is.na(issue)) %>%
  select(top, urls) %>%
  arrange(top) %>%
  DT::datatable(escape = FALSE)
```


Data 
============================

### All SO questions mentionned in GH issues 

This table contains TOP 500 QA from SO and where they are mentionned in issues

```{r render-full-table}
DT::datatable(full_table %>% 
                select(-issue) %>%
                # put top = 0 for non top 500 SO QA
                mutate(top = if_else(is.na(top), 0L, top)),
              escape = FALSE, 
              filter = "top", 
              options = list(
                columnDefs = list(list(className = 'dt-center', targets = 0:4))
              ))
```

