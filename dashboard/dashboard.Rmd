---
title: "Dashboard question"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(polite)
library(rvest)
library(purrr)
```

# Get Top 500 SO questions

## scrape website
```{r}
# we want to retrieve the 500 top question
so_url <- "https://stackoverflow.com/questions/tagged/r-markdown"
session <- bow(so_url)
top <- 500
result_per_page <- 50
nb_page <- ceiling(top / 50)
# nb_page <- 1
res <- seq_len(nb_page) %>%
  map(~ scrape(session, 
               params = glue::glue("page={page_nb}&sort=votes&pagesize={result_per_page}", 
                                   page_nb = .x), verbose = TRUE
  ))

```


## get question url
```{r, eval = FALSE}
so_top_qa <- res %>%
  map(~html_nodes(.x, "h3 >a.question-hyperlink") %>%
        html_attr("href") %>%
        map_chr(~ httr::modify_url(so_url, path = .x))) %>%
  flatten_chr() %>%
  tibble(urls = .) %>%
  mutate(
    top = row_number(),
    id = str_extract(urls, "(?<=/)\\d{8}(?=/)") 
  )
readr::write_csv(so_top_qa, here::here("dashboard/TOP500_QA_SO.csv"))
```


# Find QA already looked at on GH

Use github graphQL API


```{r}
library(ghrecipes)
owner <- "mikey-harper"
repo <- "rmarkdown-cookbook"
ignored_issues <- c(4)
issues <- get_issue_labels_state(owner, repo)
get_all_thread <- map_dfr(issues$number, ~ get_issue_thread(owner, repo, .x))
so_in_gh <- get_all_thread %>%
  select(issue, body) %>%
  # do not select some issue
  filter(issue != 4) %>%
  # get only issues with stackoverflow url
  mutate(has_so_url = str_detect(body, "https://stackoverflow.com")) %>%
  filter(has_so_url) %>%
  mutate(so_url = str_extract_all(body, "\\bhttps://stackoverflow.com/[^\\s)]*")) %>%
  unnest(so_url) %>%
  # deal with comment shared url
  mutate(so_url = map_if(so_url, 
                         ~str_detect(.x, "https://stackoverflow.com/a/.*"), 
                         ~httr::GET(.x)$url) %>% flatten_chr,
         id = str_extract(so_url, "(?<=questions/)\\d{8}(?=/.*)")) %>%
  select(issue, so_url_gh = so_url, id) %>%
  distinct()
so_in_gh
```

# summary of already dealt issues

```{r}
top_QA <- read_csv(here::here("dashboard", "TOP500_QA_SO.csv"), col_types = "cic")
full_table <- so_in_gh %>%
  full_join(top_QA, by = "id")
```


